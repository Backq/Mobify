name: Build iOS IPA

on:
  workflow_dispatch: # Allow manual trigger
  push:
    branches: [ main ]
    paths:
      - 'ios/**'
      - '.github/workflows/build-ios.yml'

jobs:
  build:
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2.0'

      - name: Set up Xcode Project
        run: |
          mkdir -p MobifyApp/MobifyApp
          cp ios/WebViewWrapper.swift MobifyApp/MobifyApp/ContentView.swift
          cp ios/CarPlayDelegate.swift MobifyApp/MobifyApp/CarPlayDelegate.swift
          cp ios/entitlements.plist MobifyApp/entitlements.plist
          
          # Info.plist with CarPlay Scene Manifest and Background Modes
          cat <<EOF > MobifyApp/MobifyApp/Info.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>\$(EXECUTABLE_NAME)</string>
              <key>CFBundleIdentifier</key>
              <string>xyz.mobware.music</string>
              <key>CFBundleName</key>
              <string>Mobify</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0</string>
              <key>CFBundleVersion</key>
              <string>${{ github.run_number }}</string>
              <key>LSRequiresIPhoneOS</key>
              <true/>
              <key>UILaunchScreen</key>
              <dict/>
              <key>UIRequiredDeviceCapabilities</key>
              <array>
                  <string>armv7</string>
              </array>
              <key>UISupportedInterfaceOrientations</key>
              <array>
                  <string>UIInterfaceOrientationPortrait</string>
              </array>
              <key>NSAppTransportSecurity</key>
              <dict>
                  <key>NSAllowsArbitraryLoads</key>
                  <true/>
              </dict>
              <key>UIBackgroundModes</key>
              <array>
                  <string>audio</string>
                  <string>fetch</string>
              </array>
              <key>getApplicationSceneManifest</key>
              <dict>
                  <key>UIApplicationSupportsMultipleScenes</key>
                  <true/>
              </dict>
              <key>UIApplicationSceneManifest</key>
              <dict>
                  <key>UIApplicationSupportsMultipleScenes</key>
                  <true/>
                  <key>UISceneConfigurations</key>
                  <dict>
                      <key>CPTemplateApplicationSceneSessionRoleApplication</key>
                      <array>
                          <dict>
                              <key>UISceneClassName</key>
                              <string>CPTemplateApplicationScene</string>
                              <key>UISceneConfigurationName</key>
                              <string>CarPlay</string>
                              <key>UISceneDelegateClassName</key>
                              <string>\$(PRODUCT_MODULE_NAME).CarPlaySceneDelegate</string>
                          </dict>
                      </array>
                      <key>UIWindowSceneSessionRoleApplication</key>
                      <array>
                          <dict>
                              <key>UISceneConfigurationName</key>
                              <string>Default Configuration</string>
                              <key>UISceneDelegateClassName</key>
                              <string>\$(PRODUCT_MODULE_NAME).SceneDelegate</string>
                          </dict>
                      </array>
                  </dict>
              </dict>
              <key>CPSupportedExternalDisplay</key>
              <true/>
              <key>CPSupportedExternalStyles</key>
              <integer>15</integer>
          </dict>
          </plist>
          EOF

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode Project
        run: |
          cat <<EOF > project.yml
          name: Mobify
          options:
            bundleIdPrefix: xyz.mobware
          targets:
            Mobify:
              type: application
              platform: iOS
              deploymentTarget: "15.0"
              sources: [MobifyApp/MobifyApp]
              settings:
                INFOPLIST_FILE: MobifyApp/MobifyApp/Info.plist
                PRODUCT_BUNDLE_IDENTIFIER: xyz.mobware.music
                CODE_SIGNING_REQUIRED: NO
                CODE_SIGNING_ALLOWED: NO
                CODE_SIGN_STYLE: Manual
          EOF
          xcodegen generate

      - name: Build Archive
        run: |
          xcodebuild archive \
            -project Mobify.xcodeproj \
            -scheme Mobify \
            -archivePath Mobify.xcarchive \
            -destination 'generic/platform=iOS' \
            -entitlements MobifyApp/entitlements.plist \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            AD_HOC_CODE_SIGNING_ALLOWED=YES

      - name: Create IPA
        run: |
          mkdir -p Payload
          cp -r Mobify.xcarchive/Products/Applications/Mobify.app Payload/
          zip -r Mobify.ipa Payload
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ios-v${{ github.run_number }}
          name: Mobify iOS Build #${{ github.run_number }}
          files: Mobify.ipa
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
