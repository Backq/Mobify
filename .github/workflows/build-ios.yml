name: Build iOS IPA

on:
  workflow_dispatch: # Allow manual trigger
  push:
    branches: [ main ]
    paths:
      - 'ios/**'
      - '.github/workflows/build-ios.yml'

jobs:
  build:
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2.0'

      - name: Set up Xcode Project
        run: |
          mkdir -p MobifyApp/MobifyApp
          cp ios/WebViewWrapper.swift MobifyApp/MobifyApp/ContentView.swift
          
          # App Icon Setup
          mkdir -p MobifyApp/MobifyApp/Assets.xcassets/AppIcon.appiconset
          cp client/src/assets/logo.png MobifyApp/MobifyApp/Assets.xcassets/AppIcon.appiconset/icon.png
          
          cat <<EOF > MobifyApp/MobifyApp/Assets.xcassets/AppIcon.appiconset/Contents.json
          {
            "images" : [
              {
                "idiom" : "universal",
                "platform" : "ios",
                "size" : "1024x1024",
                "filename" : "icon.png"
              }
            ],
            "info" : {
              "version" : 1,
              "author" : "xcode"
            }
          }
          EOF

          # Info.plist with CarPlay and Background Modes
          cat <<EOF > MobifyApp/MobifyApp/Info.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>\$(EXECUTABLE_NAME)</string>
              <key>CFBundleIdentifier</key>
              <string>xyz.mobware.music</string>
              <key>CFBundleName</key>
              <string>Mobify</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0</string>
              <key>CFBundleVersion</key>
              <string>${{ github.run_number }}</string>
              <key>LSRequiresIPhoneOS</key>
              <true/>
              <key>UILaunchScreen</key>
              <dict/>
              <key>UIRequiredDeviceCapabilities</key>
              <array>
                  <string>armv7</string>
              </array>
              <key>UISupportedInterfaceOrientations</key>
              <array>
                  <string>UIInterfaceOrientationPortrait</string>
              </array>
              <key>NSAppTransportSecurity</key>
              <dict>
                  <key>NSAllowsArbitraryLoads</key>
                  <true/>
              </dict>
              <key>UIBackgroundModes</key>
              <array>
                  <string>audio</string>
                  <string>fetch</string>
              </array>
              <key>CPSupportedExternalDisplay</key>
              <true/>
              <key>CPSupportedExternalStyles</key>
              <integer>15</integer>
          </dict>
          </plist>
          EOF

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode Project
        run: |
          cat <<EOF > project.yml
          name: Mobify
          options:
            bundleIdPrefix: xyz.mobware
          targets:
            Mobify:
              type: application
              platform: iOS
              deploymentTarget: "15.0"
              sources: [MobifyApp/MobifyApp]
              settings:
                INFOPLIST_FILE: MobifyApp/MobifyApp/Info.plist
                ASSETCATALOG_COMPILER_APPICON_NAME: AppIcon
                PRODUCT_BUNDLE_IDENTIFIER: xyz.mobware.music
                CODE_SIGNING_REQUIRED: NO
                CODE_SIGNING_ALLOWED: NO
                CODE_SIGN_STYLE: Manual
          EOF
          xcodegen generate

      - name: Build Archive
        run: |
          xcodebuild archive \
            -project Mobify.xcodeproj \
            -scheme Mobify \
            -archivePath Mobify.xcarchive \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            AD_HOC_CODE_SIGNING_ALLOWED=YES \
            ASSETCATALOG_COMPILER_SKIP_SDK_VALIDATION=YES

      - name: Create IPA
        run: |
          mkdir -p Payload
          cp -r Mobify.xcarchive/Products/Applications/Mobify.app Payload/
          zip -r Mobify.ipa Payload
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ios-v${{ github.run_number }}
          name: Mobify iOS Build #${{ github.run_number }}
          files: Mobify.ipa
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
